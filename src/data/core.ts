import { FileBuilder } from "../core/helpers/file-builder";

const src_core_cli_init = () => {
	const fb = new FileBuilder();
	fb.addLine("import log from \"./log\";")
	fb.addLine("import { join } from \"node:path\";")
	fb.addLine("import { config } from \"../config\";")
	fb.addLine("")
	fb.addLine("export type Command = {")
	fb.addLine("  name: string;")
	fb.addLine("  description: string;")
	fb.addLine("  instructions: string;")
	fb.addLine("  run: (args: string[]) => Promise<void> | void;")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("const commands = new Map<string, Command>();")
	fb.addLine("")
	fb.addLine("export function registerCommand(cmd: Command) {")
	fb.addLine("  commands.set(cmd.name, cmd);")
	fb.addLine("}")
	fb.addLine("")
	fb.addLine("export async function runCLI(argv = Bun.argv.slice(2)) {")
	fb.addLine("  const [name, ...args] = argv;")
	fb.addLine("  // -- TS Defense --")
	fb.addLine("  if (!name) {")
	fb.addLine("    log.single.err(\"ARGS\", \"No Argument Supplied\");")
	fb.addLine("    return;")
	fb.addLine("  }")
	fb.addLine("  if ([\"-h\", \"--help\"].includes(name)) {")
	fb.addLine("    const multiLog: any[] = [];")
	fb.addLine("    multiLog.push({")
	fb.addLine("      t: \"About\",")
	fb.addLine("      m: config.about_text,")
	fb.addLine("    });")
	fb.addLine("    multiLog.push({")
	fb.addLine("      t: \"Commands\",")
	fb.addLine("      m: \"Available Commands\",")
	fb.addLine("    });")
	fb.addLine("    for (const cmd of commands.values()) {")
	fb.addLine("      multiLog.push({")
	fb.addLine("        t: cmd.name,")
	fb.addLine("        m: `${cmd.description}\\n  |->  [Instructions]: ${cmd.instructions}\\n`,")
	fb.addLine("      });")
	fb.addLine("    }")
	fb.addLine("    multiLog.push({")
	fb.addLine("      t: \"More Info\",")
	fb.addLine("      m: config.more_info_text,")
	fb.addLine("    });")
	fb.addLine("    log.multi.info(multiLog);")
	fb.addLine("    return;")
	fb.addLine("  }")
	fb.addLine("")
	fb.addLine("  if ([\"-v\", \"--version\"].includes(name)) {")
	fb.addLine("    const pkgText = await Bun.file(join(process.cwd(), \"package.json\")).text();")
	fb.addLine("    const pkg = JSON.parse(pkgText);")
	fb.addLine("    log.multi.info([")
	fb.addLine("      {")
	fb.addLine("        t: \"Package Name\",")
	fb.addLine("        m: pkg.name,")
	fb.addLine("      },")
	fb.addLine("      {")
	fb.addLine("        t: \"Package Version\",")
	fb.addLine("        m: pkg.version,")
	fb.addLine("      },")
	fb.addLine("    ]);")
	fb.addLine("    return;")
	fb.addLine("  }")
	fb.addLine("")
	fb.addLine("  const command = commands.get(name);")
	fb.addLine("  if (!command) {")
	fb.addLine("    log.single.err(\"Command\", \"No Command Supplied\");")
	fb.addLine("    process.exit(1);")
	fb.addLine("  }")
	fb.addLine("")
	fb.addLine("  try {")
	fb.addLine("    await command.run(args);")
	fb.addLine("  } catch (err) {")
	fb.addLine("    const multilog: any[] = [];")
	fb.addLine("    multilog.push({")
	fb.addLine("      t: \"Panic\",")
	fb.addLine("      m: `Failed to run ${name}`,")
	fb.addLine("    });")
	fb.addLine("    if (err instanceof Error) {")
	fb.addLine("      multilog.push({")
	fb.addLine("        t: \"Error\",")
	fb.addLine("        m: err.message,")
	fb.addLine("      });")
	fb.addLine("    } else {")
	fb.addLine("      multilog.push({")
	fb.addLine("        t: \"Unknown Error\",")
	fb.addLine("        m: JSON.stringify(err),")
	fb.addLine("      });")
	fb.addLine("    }")
	fb.addLine("    log.multi.err(multilog);")
	fb.addLine("    process.exit(1);")
	fb.addLine("  }")
	fb.addLine("}")
	fb.addLine("")
	return fb.build();
};

export const src_core_cli = {
	location: "src/core/cli.ts",
	content: src_core_cli_init
};

const src_core_helpers_stringifier_init = () => {
	const fb = new FileBuilder();
	fb.addLine("import { join } from \"node:path\";")
	fb.addLine("import { readdir, writeFile } from \"node:fs/promises\";")
	fb.addLine("import { FileBuilder } from \"./file-builder\";")
	fb.addLine("import { statSync } from \"node:fs\";")
	fb.addLine("")
	fb.addLine("const outExport: string[] = [];")
	fb.addLine("")
	fb.addLine("async function generateTemplate(path: string) {")
	fb.addLine("  if (path.endsWith(\".ts\")) {")
	fb.addLine("    const content = await Bun.file(path).text();")
	fb.addLine("    const fb = new FileBuilder();")
	fb.addLine("    const snaked_title = path")
	fb.addLine("      .split(\"/\")")
	fb.addLine("      .join(\"_\")")
	fb.addLine("      .split(\"-\")")
	fb.addLine("      .join(\"_\")")
	fb.addLine("      .split(\".\")[0];")
	fb.addLine("    fb.addLine(`const ${snaked_title + \"_init\"} = () => {`);")
	fb.addLine("    fb.addLine(`const fb = new FileBuilder();`, 1);")
	fb.addLine("    const lines = content.split(\"\\n\");")
	fb.addLine("    for (const line of lines) {")
	fb.addLine("      const cleanLine = line.replaceAll(\"\\\\\", \"\\\\\\\\\").replaceAll('\"', '\\\\\"');")
	fb.addLine("      fb.addLine(`fb.addLine(\"${cleanLine}\")`, 1);")
	fb.addLine("    }")
	fb.addLine("    fb.addLine(\"return fb.build();\", 1);")
	fb.addLine("    fb.addLine(\"};\");")
	fb.addLine("    fb.addEmptyLine();")
	fb.addLine("    fb.addLine(`export const ${snaked_title} = {`);")
	fb.addLine("    fb.addLine(`location: \"${path}\",`, 1);")
	fb.addLine("    fb.addLine(`content: ${snaked_title + \"_init\"}`, 1);")
	fb.addLine("    fb.addLine(`};`);")
	fb.addLine("    const out = fb.build();")
	fb.addLine("    outExport.push(`${snaked_title}`);")
	fb.addLine("    return out;")
	fb.addLine("  }")
	fb.addLine("  return \"\";")
	fb.addLine("}")
	fb.addLine("")
	fb.addLine("async function parseFolder(path: string, fb: FileBuilder) {")
	fb.addLine("  const items = await readdir(path);")
	fb.addLine("  for (const item of items) {")
	fb.addLine("    const relPath = join(path, item);")
	fb.addLine("    const itemStat = statSync(relPath);")
	fb.addLine("    if (itemStat.isDirectory()) {")
	fb.addLine("      await parseFolder(relPath, fb);")
	fb.addLine("    }")
	fb.addLine("    if (item.endsWith(\".ts\")) {")
	fb.addLine("      fb.addLine(await generateTemplate(relPath));")
	fb.addLine("      fb.addEmptyLine();")
	fb.addLine("    }")
	fb.addLine("  }")
	fb.addLine("}")
	fb.addLine("")
	fb.addLine("async function generateTemplates() {")
	fb.addLine("  const sourceCoreDir = join(\".\", \"src\", \"core\");")
	fb.addLine("  const fb = new FileBuilder();")
	fb.addLine("  fb.addLine(`import { FileBuilder } from \"../core/helpers/file-builder\";`);")
	fb.addLine("  fb.addEmptyLine();")
	fb.addLine("  await parseFolder(sourceCoreDir, fb);")
	fb.addLine("  fb.addLine(`const core = [${outExport.join(\", \")}]`);")
	fb.addLine("  fb.addLine(`export { core }`);")
	fb.addLine("  const out = fb.build();")
	fb.addLine("  await writeFile(join(\".\", \"src\", \"data\", \"core.ts\"), out, \"utf8\");")
	fb.addLine("}")
	fb.addLine("")
	fb.addLine("generateTemplates();")
	fb.addLine("")
	return fb.build();
};

export const src_core_helpers_stringifier = {
	location: "src/core/helpers/stringifier.ts",
	content: src_core_helpers_stringifier_init
};

const src_core_helpers_file_builder_init = () => {
	const fb = new FileBuilder();
	fb.addLine("export function line(content: string, depth: number): string {")
	fb.addLine("  return `\\n${\"\\t\".repeat(depth)}${content}`;")
	fb.addLine("}")
	fb.addLine("")
	fb.addLine("export class FileBuilder {")
	fb.addLine("  private lines: string[] = [];")
	fb.addLine("")
	fb.addLine("  addLine(content: string, depth: number = 0): void {")
	fb.addLine("    this.lines.push(`${\"\\t\".repeat(depth)}${content}`);")
	fb.addLine("  }")
	fb.addLine("")
	fb.addLine("  addEmptyLine(): void {")
	fb.addLine("    this.lines.push(\"\");")
	fb.addLine("  }")
	fb.addLine("")
	fb.addLine("  build(): string {")
	fb.addLine("    return this.lines.join(\"\\n\");")
	fb.addLine("  }")
	fb.addLine("}")
	fb.addLine("")
	return fb.build();
};

export const src_core_helpers_file_builder = {
	location: "src/core/helpers/file-builder.ts",
	content: src_core_helpers_file_builder_init
};

const src_core_helpers_file_utils_init = () => {
	const fb = new FileBuilder();
	fb.addLine("import { mkdir } from \"node:fs/promises\";")
	fb.addLine("import { resolve, join } from \"node:path\";")
	fb.addLine("")
	fb.addLine("export async function writeFileTuple([targetDir, relativePath, content]: [string, string, string]): Promise<void> {")
	fb.addLine("  const fullPath = resolve(targetDir, relativePath);")
	fb.addLine("  await mkdir(join(fullPath, \"..\"), { recursive: true });")
	fb.addLine("  await Bun.write(fullPath, content);")
	fb.addLine("}")
	fb.addLine("")
	return fb.build();
};

export const src_core_helpers_file_utils = {
	location: "src/core/helpers/file-utils.ts",
	content: src_core_helpers_file_utils_init
};

const src_core_log_init = () => {
	const fb = new FileBuilder();
	fb.addLine("import figlet from \"figlet\";")
	fb.addLine("")
	fb.addLine("const infoLogSingle = (title: string, message: string) => {")
	fb.addLine("  console.log(\"\");")
	fb.addLine("  console.info(\"  [INFO]\");")
	fb.addLine("  console.info(`  [${title}]: ${message}`);")
	fb.addLine("  console.log(\"\");")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("type MultiLogArgs = {")
	fb.addLine("  t: string;")
	fb.addLine("  m: string;")
	fb.addLine("}[];")
	fb.addLine("")
	fb.addLine("const infoLogMulti = (args: MultiLogArgs) => {")
	fb.addLine("  console.log(\"\");")
	fb.addLine("  console.info(\"  [INFO]\");")
	fb.addLine("  for (const arg of args) {")
	fb.addLine("    console.info(`  [${arg.t}]: ${arg.m}`);")
	fb.addLine("  }")
	fb.addLine("  console.log(\"\");")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("const warnLogSingle = (title: string, message: string) => {")
	fb.addLine("  console.log(\"\");")
	fb.addLine("  console.warn(\"  [WARNING]\");")
	fb.addLine("  console.warn(`  [${title}]: ${message}`);")
	fb.addLine("  console.log(\"\");")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("const warnLogMulti = (args: MultiLogArgs) => {")
	fb.addLine("  console.log(\"\");")
	fb.addLine("  console.warn(\"  [WARNING]\");")
	fb.addLine("  for (const arg of args) {")
	fb.addLine("    console.warn(`  [${arg.t}]: ${arg.m}`);")
	fb.addLine("  }")
	fb.addLine("  console.log(\"\");")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("const errLogSingle = (title: string, message: string) => {")
	fb.addLine("  console.log(\"\");")
	fb.addLine("  console.error(\"  [ERROR]\");")
	fb.addLine("  console.error(`  [${title}]: ${message}`);")
	fb.addLine("  console.log(\"\");")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("const errLogMulti = (args: MultiLogArgs) => {")
	fb.addLine("  console.log(\"\");")
	fb.addLine("  console.error(\"  [ERROR]\");")
	fb.addLine("  for (const arg of args) {")
	fb.addLine("    console.error(`  [${arg.t}]: ${arg.m}`);")
	fb.addLine("  }")
	fb.addLine("  console.log(\"\");")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("const title = (title: string, subtitle?: string) => {")
	fb.addLine("  console.clear();")
	fb.addLine("  console.log();")
	fb.addLine("  console.log(")
	fb.addLine("    figlet.textSync(title, {")
	fb.addLine("      font: \"ANSI Regular\",")
	fb.addLine("    }),")
	fb.addLine("  );")
	fb.addLine("  console.log(`  [${subtitle}]`);")
	fb.addLine("  console.log();")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("const log = {")
	fb.addLine("  single: {")
	fb.addLine("    info: infoLogSingle,")
	fb.addLine("    warn: warnLogSingle,")
	fb.addLine("    err: errLogSingle,")
	fb.addLine("  },")
	fb.addLine("  multi: {")
	fb.addLine("    info: infoLogMulti,")
	fb.addLine("    warn: warnLogMulti,")
	fb.addLine("    err: errLogMulti,")
	fb.addLine("  },")
	fb.addLine("  title,")
	fb.addLine("};")
	fb.addLine("")
	fb.addLine("export default log;")
	fb.addLine("")
	return fb.build();
};

export const src_core_log = {
	location: "src/core/log.ts",
	content: src_core_log_init
};

const core = [src_core_cli, src_core_helpers_stringifier, src_core_helpers_file_builder, src_core_helpers_file_utils, src_core_log]
export { core }